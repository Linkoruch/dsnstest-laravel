# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—É —Å–ø—Ä–æ–±

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–µ—Å—Ç—É –∑ –æ–±–º–µ–∂–µ–Ω–Ω—è–º –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Å–ø—Ä–æ–± (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 3), –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø—Ä–æ–±–∞–º–∏" —É –∫–æ–ª–æ–Ω—Ü—ñ "–ó–∞–ª–∏—à–∏–ª–æ—Å—å" –ø–æ–∫–∞–∑—É–≤–∞–ª–æ—Å—å "–í–∏—á–µ—Ä–ø–∞–Ω–æ" –∞–±–æ 0 –∑–∞–º—ñ—Å—Ç—å 3 –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—ñ —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç.

## –ü—Ä–∏—á–∏–Ω–∞
–ö–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–≤ —Ç–µ—Å—Ç, –∑–∞–ø–∏—Å —É —Ç–∞–±–ª–∏—Ü—ñ `user_test_attempts` —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –º–µ—Ç–æ–¥–æ–º `getUserAttempt()`, –∞–ª–µ –∑–≤'—è–∑–æ–∫ –∑ –º–æ–¥–µ–ª–ª—é `Test` –Ω–µ –∑–∞–≤–∂–¥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–≤—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ, —â–æ –ø—Ä–∏–∑–≤–æ–¥–∏–ª–æ –¥–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–∞–ª–∏—à–∫—É —Å–ø—Ä–æ–±.

## –†—ñ—à–µ–Ω–Ω—è

### 1. –û–Ω–æ–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥ `getUserAttempt()` –≤ –º–æ–¥–µ–ª—ñ Test

**–§–∞–π–ª:** `app/Models/Test.php`

**–ë—É–ª–æ:**
```php
public function getUserAttempt($userId): UserTestAttempt
{
    return UserTestAttempt::firstOrCreate(
        [
            'user_id' => $userId,
            'test_id' => $this->id,
        ],
        [
            'attempts_used' => 0,
            'bonus_attempts' => 0,
        ]
    );
}
```

**–°—Ç–∞–ª–æ:**
```php
public function getUserAttempt($userId): UserTestAttempt
{
    $attempt = UserTestAttempt::firstOrCreate(
        [
            'user_id' => $userId,
            'test_id' => $this->id,
        ],
        [
            'attempts_used' => 0,
            'bonus_attempts' => 0,
        ]
    );
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–≤'—è–∑–æ–∫ test, —è–∫—â–æ –≤—ñ–Ω –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
    if (!$attempt->relationLoaded('test')) {
        $attempt->setRelation('test', $this);
    }
    
    return $attempt;
}
```

### 2. –û–Ω–æ–≤–ª–µ–Ω–æ –º–µ—Ç–æ–¥ `getTotalAvailableAttempts()` –≤ –º–æ–¥–µ–ª—ñ UserTestAttempt

**–§–∞–π–ª:** `app/Models/UserTestAttempt.php`

**–ë—É–ª–æ:**
```php
public function getTotalAvailableAttempts(): int
{
    $testLimit = $this->test->attempts_limit;

    if ($testLimit === null) {
        return PHP_INT_MAX;
    }

    return $testLimit + $this->bonus_attempts;
}
```

**–°—Ç–∞–ª–æ:**
```php
public function getTotalAvailableAttempts(): int
{
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑–≤'—è–∑–æ–∫ –∑ —Ç–µ—Å—Ç–æ–º
    if (!$this->test) {
        $this->load('test');
    }
    
    $testLimit = $this->test->attempts_limit;

    if ($testLimit === null) {
        return PHP_INT_MAX;
    }

    return $testLimit + $this->bonus_attempts;
}
```

## –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î —Ç–µ–ø–µ—Ä

### –ü—Ä–∏–∫–ª–∞–¥ 1: –ù–æ–≤–∏–π —Ç–µ—Å—Ç –∑ 3 —Å–ø—Ä–æ–±–∞–º–∏

**–î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- –°—Ç–≤–æ—Ä—é—î—Ç–µ —Ç–µ—Å—Ç –∑ `attempts_limit = 3`
- –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø—Ä–æ–±–∞–º–∏"
- –ë–∞—á–∏—Ç–µ: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 0, –ó–∞–ª–∏—à–∏–ª–æ—Å—å: **–í–∏—á–µ—Ä–ø–∞–Ω–æ** ‚ùå

**–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
- –°—Ç–≤–æ—Ä—é—î—Ç–µ —Ç–µ—Å—Ç –∑ `attempts_limit = 3`
- –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø—Ä–æ–±–∞–º–∏"
- –ë–∞—á–∏—Ç–µ: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 0, –ó–∞–ª–∏—à–∏–ª–æ—Å—å: **3** ‚úÖ

### –ü—Ä–∏–∫–ª–∞–¥ 2: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ–π—à–æ–≤ —Ç–µ—Å—Ç 1 —Ä–∞–∑

**–¢–µ—Å—Ç –º–∞—î 5 —Å–ø—Ä–æ–±:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 1
- –ó–∞–ª–∏—à–∏–ª–æ—Å—å: **4** ‚úÖ

### –ü—Ä–∏–∫–ª–∞–¥ 3: –ó –±–æ–Ω—É—Å–Ω–∏–º–∏ —Å–ø—Ä–æ–±–∞–º–∏

**–¢–µ—Å—Ç –º–∞—î 3 —Å–ø—Ä–æ–±–∏ + –¥–æ–¥–∞–Ω–æ 2 –±–æ–Ω—É—Å–Ω—ñ:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 0
- –ó–∞–ª–∏—à–∏–ª–æ—Å—å: **5** ‚úÖ (3 –±–∞–∑–æ–≤—ñ + 2 –±–æ–Ω—É—Å–Ω—ñ)

### –ü—Ä–∏–∫–ª–∞–¥ 4: –ù–µ–æ–±–º–µ–∂–µ–Ω—ñ —Å–ø—Ä–æ–±–∏

**–¢–µ—Å—Ç –∑ `attempts_limit = null`:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 10
- –ó–∞–ª–∏—à–∏–ª–æ—Å—å: **–ù–µ–æ–±–º–µ–∂–µ–Ω–æ** ‚úÖ

## –©–æ –±—É–ª–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

‚úÖ **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É:** –¢–µ–ø–µ—Ä –∑–≤'—è–∑–æ–∫ `test` –∑–∞–≤–∂–¥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ:** –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —á–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑–≤'—è–∑–æ–∫ –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º
‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:** –ó–∞–ª–∏—à–æ–∫ —Å–ø—Ä–æ–± = (–ª—ñ–º—ñ—Ç —Ç–µ—Å—Ç—É + –±–æ–Ω—É—Å–Ω—ñ —Å–ø—Ä–æ–±–∏) - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Å–ø—Ä–æ–±–∏
‚úÖ **–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è:** –ö–æ–ª–æ–Ω–∫–∞ "–ó–∞–ª–∏—à–∏–ª–æ—Å—å" –ø–æ–∫–∞–∑—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

## –§–æ—Ä–º—É–ª–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É

```
total_available = test.attempts_limit + bonus_attempts
remaining = total_available - attempts_used

–ü—Ä–∏–∫–ª–∞–¥–∏:
- –õ—ñ–º—ñ—Ç: 3, –ë–æ–Ω—É—Å: 0, –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 0 ‚Üí –ó–∞–ª–∏—à–∏–ª–æ—Å—å: 3
- –õ—ñ–º—ñ—Ç: 3, –ë–æ–Ω—É—Å: 2, –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 1 ‚Üí –ó–∞–ª–∏—à–∏–ª–æ—Å—å: 4
- –õ—ñ–º—ñ—Ç: 5, –ë–æ–Ω—É—Å: 0, –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: 5 ‚Üí –ó–∞–ª–∏—à–∏–ª–æ—Å—å: 0 (–í–∏—á–µ—Ä–ø–∞–Ω–æ)
- –õ—ñ–º—ñ—Ç: null ‚Üí –ó–∞–ª–∏—à–∏–ª–æ—Å—å: –ù–µ–æ–±–º–µ–∂–µ–Ω–æ
```

## –í–∏–∫–æ–Ω–∞–Ω—ñ –¥—ñ—ó

1. ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `Test::getUserAttempt()` - –¥–æ–¥–∞–Ω–æ —è–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤'—è–∑–∫—É
2. ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `UserTestAttempt::getTotalAvailableAttempts()` - –¥–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∑–≤'—è–∑–∫—É
3. ‚úÖ –û—á–∏—â–µ–Ω–æ –∫–µ—à—ñ (`php artisan optimize:clear`)

–ü—Ä–æ–±–ª–µ–º–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞! –¢–µ–ø–µ—Ä –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø—Ä–æ–±–∞–º–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ª–∏—à–∫–æ–≤–∏—Ö —Å–ø—Ä–æ–± –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤. üéâ

