# Система доступу до тестів на основі рівня ризику

## Огляд змін

Система доступу до тестів була змінена з призначення окремих користувачів на систему на основі рівнів ризику.

## Що було змінено

### 1. База даних

#### Таблиця `users`
Додано поле `risk_level`:
- Значення: `'high'`, `'low'`, або `NULL`
- Призначення: визначає рівень ризику користувача

#### Таблиця `tests`
- **Видалено**: `assigned_users` (JSON поле зі списком користувачів)
- **Додано**: `risk_levels` (JSON поле зі списком рівнів ризику)
  - Приклад: `["high"]`, `["low"]`, `["high", "low"]`, або `NULL`
  - Якщо `NULL` або порожній масив - тест доступний всім користувачам

### 2. Моделі

#### User Model (`app/Models/User.php`)
- Додано константи:
  - `User::RISK_HIGH = 'high'`
  - `User::RISK_LOW = 'low'`
- Додано поле `risk_level` до `$fillable`

#### Test Model (`app/Models/Test.php`)
- Додано константи:
  - `Test::RISK_HIGH = 'high'`
  - `Test::RISK_LOW = 'low'`
- Змінено `$fillable`: `assigned_users` → `risk_levels`
- Змінено `casts`: `assigned_users` → `risk_levels`
- Оновлено метод `isAvailableForUser($userId)`:
  - Тепер перевіряє рівень ризику користувача
  - Якщо `risk_levels` порожній - тест доступний всім
  - Якщо рівень ризику користувача є в масиві `risk_levels` - доступ дозволено
- Замінено метод `getAssignedUserIds()` на `getRiskLevels()`

### 3. Компоненти управління користувачами

#### CreateUser (`app/Livewire/Users/CreateUser.php`)
- Додано поле `$risk_level` (за замовчуванням: `'low'`)
- Додано валідацію для `risk_level`
- Рівень ризику зберігається при створенні користувача

#### EditUser (`app/Livewire/Users/EditUser.php`)
- Додано поле `$risk_level`
- Рівень ризику завантажується та зберігається при редагуванні

#### Views
- `create-user.blade.php`: додано випадаюче меню для вибору рівня ризику
- `edit-user.blade.php`: додано випадаюче меню для вибору рівня ризику
- `user-list.blade.php`: додано колонку з відображенням рівня ризику користувача

### 4. Компоненти управління тестами

#### CreateTest (`app/Livewire/Tests/CreateTest.php`)
- **Видалено**: `$assignToAll`, `$selectedUsers`, `$availableUsers`
- **Додано**: `$selectedRiskLevels` (масив обраних рівнів ризику)
- Тести створюються з вибраними рівнями ризику

#### EditTest (`app/Livewire/Tests/EditTest.php`)
- **Видалено**: `$assignToAll`, `$selectedUsers`, `$availableUsers`
- **Додано**: `$selectedRiskLevels` (масив обраних рівнів ризику)
- Рівні ризику завантажуються та зберігаються при редагуванні

#### Views
- `create-test.blade.php`: 
  - Видалено секцію вибору користувачів
  - Додано чекбокси для вибору рівнів ризику (Високий/Низький)
  - Якщо жоден рівень не обрано - тест доступний всім
  
- `edit-test.blade.php`:
  - Видалено секцію вибору користувачів
  - Додано чекбокси для вибору рівнів ризику (Високий/Низький)

### 5. Компонент доступних тестів для користувача

#### AvailableTests (`app/Livewire/UserTests/AvailableTests.php`)
- Оновлено логіку вибірки тестів:
  - Тести без `risk_levels` (NULL) - доступні всім
  - Тести з рівнем ризику користувача - доступні
  - Користувачі без рівня ризику бачать тільки тести без обмежень

## Як це працює

### Створення користувача
1. Адміністратор створює користувача
2. Обирає рівень ризику: "Високий ризик" або "Низький ризик" (або залишає порожнім)
3. Рівень ризику зберігається в БД

### Створення тесту
1. Адміністратор створює тест
2. Обирає рівні ризику, для яких тест буде доступний:
   - Високий ризик
   - Низький ризик
   - Обидва рівні
   - Жоден (тест доступний всім)
3. Рівні ризику зберігаються в БД

### Доступ до тестів
Користувач бачить тести:
- Без рівнів ризику (доступні всім)
- З його рівнем ризику

**Приклад:**
- Користувач з рівнем "Високий ризик" бачить:
  - Тести без рівнів ризику
  - Тести з рівнем "Високий ризик"
  - Не бачить тести тільки для "Низького ризику"

## Міграції

### Виконані міграції:
1. `2026_02_07_102541_add_risk_level_to_users_table.php`
   - Додає `risk_level` до таблиці `users`

2. `2026_02_07_102600_update_tests_table_for_risk_levels.php`
   - Видаляє `assigned_users` з таблиці `tests`
   - Додає `risk_levels` до таблиці `tests`

## Переваги нової системи

1. **Простіше управління**: не потрібно вибирати кожного користувача окремо
2. **Масштабованість**: легко додавати нових користувачів з певним рівнем ризику
3. **Гнучкість**: можна створювати тести для одного, кількох або всіх рівнів ризику
4. **Зрозумілість**: чіткі категорії користувачів за рівнем ризику

## Важливі зауваження

- Якщо у користувача немає рівня ризику (`NULL`), він бачить тільки тести без обмежень
- Якщо у тесту немає рівнів ризику (`NULL` або порожній масив), його бачать всі користувачі
- Адміністратори можуть змінювати рівень ризику користувачів у будь-який час
- Зміна рівня ризику користувача автоматично змінює його доступ до тестів

